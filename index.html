<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æè´§å•ä¿®æ”¹å™¨ (å®Œç¾ç¼“å­˜ç‰ˆ)</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: "Microsoft YaHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 850px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; display: inline-block; }
        
        .tip-box { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; margin-bottom: 20px; color: #2e7d32; font-size: 13px; line-height: 1.6; }
        
        .mode-switch { display: flex; background: #e9ecef; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .mode-option { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; transition: 0.3s; }
        .mode-option.active { background: white; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .upload-area { margin-bottom: 20px; padding: 15px; border: 2px dashed #ddd; border-radius: 8px; background: #fafafa; display: none; }
        .upload-area.show { display: block; animation: fadeIn 0.3s; }
        
        .field-row { background: #fafafa; border: 1px solid #eee; padding: 10px; margin-bottom: 12px; border-radius: 6px; }
        .main-inputs { display: flex; gap: 10px; margin-bottom: 8px; }
        .col { flex: 1; }
        
        .tweak-row { display: flex; gap: 5px; align-items: center; border-top: 1px dashed #ddd; padding-top: 8px; flex-wrap: wrap; }
        .tweak-item { display: flex; align-items: center; font-size: 11px; color: #666; background: #fff; padding: 2px 4px; border-radius: 4px; border: 1px solid #ddd;}
        .tweak-item label { margin-right: 2px; font-weight: normal; margin-bottom: 0; white-space: nowrap; }
        .tweak-item input { width: 35px; padding: 2px; text-align: center; border: none; border-bottom: 1px solid #ccc; font-weight: bold; color: #333; font-size: 11px;}
        
        label { display: block; font-weight: bold; font-size: 13px; color: #333; margin-bottom: 4px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        
        .input-find { background-color: #fffde7; border-color: #fbc02d; }
        
        button { width: 100%; padding: 14px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .debug-mode { background: #fff3cd; padding: 10px; border: 1px solid #ffeeba; border-radius: 4px; margin-bottom: 15px; font-size: 14px; display: flex; align-items: center; }
        .status { margin-top: 15px; padding: 10px; border-radius: 6px; font-size: 13px; min-height: 20px; font-family: monospace; white-space: pre-wrap; background: #eee; }

        /* æ–°å¢ï¼šèµ„æºåŠ è½½è¿›åº¦æ¡ */
        .resource-status { font-size: 12px; margin-bottom: 15px; padding: 8px; background: #f0faff; border: 1px solid #cceeff; border-radius: 4px; color: #006699; }
        .progress-bar { height: 4px; background: #ddd; margin-top: 5px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸš€ æè´§å•ä¿®æ”¹å™¨ (ç¼“å­˜å¢å¼ºç‰ˆ)</h2>

    <div id="resStatus" class="resource-status">
        <span id="resText">æ­£åœ¨æ£€æŸ¥æœ¬åœ°èµ„æº...</span>
        <div id="resProgress" class="progress-bar"><div id="pFill" class="progress-fill"></div></div>
    </div>
    <div class="tip-box">
        1. <b>å‚æ•°åŸºæœ¬å·²è°ƒæ•´å¥½ã€‚</b> xåç§»ä»£è¡¨å·¦å³ï¼Œyåç§»ä»£è¡¨ä¸Šä¸‹ï¼Œæ¡†é«˜åº¦ä»£è¡¨æ–‡å­—é«˜åº¦ï¼Œå®½åº¦æ‰©å±•ä»£è¡¨æ¡†åœ¨æ–‡å­—åæ‰©å±•å¤šå°‘<br>
        2. åŸç†å…¶å®å°±æ˜¯ï¼Œå…ˆæ ¹æ®å…³é”®è¯æœç´¢åˆ°æ–‡å­—ï¼Œç„¶åæ ¹æ®åç§»é‡è°ƒæ•´ä½ç½®ï¼Œä½¿ç”¨ä¸€ä¸ªç™½æ¡†è¦†ç›–ï¼Œæœ€åæ›¿æ¢æ–‡å­—ã€‚<br>
        3. å¯ä»¥ä½¿ç”¨æ¨¡ç³Šæœç´¢ï¼Œä¾‹å¦‚ï¼Œæœç´¢â€œå››å·çœâ€ï¼Œå¯ä»¥ç›´æ¥å†™å››è¿›è¡Œæœç´¢ï¼Œä½†æ˜¯æ³¨æ„ä¸è¦é‡å¤ã€‚<br>
        4. é»˜è®¤æ¨¡æ¿æ˜¯ä½ å‘æˆ‘çš„pdfç‰ˆæœ¬ï¼Œå¦‚æœä¸Šä¼ æ–°æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦å¾®è°ƒå‚æ•°ã€‚<br>
        5. <b>ä½¿ç”¨æŠ€å·§ï¼š</b> æŸ¥æ‰¾æ–‡å­—è¶ŠçŸ­è¶Šå¥½ï¼ˆå¦‚æœâ€œ2025â€è€Œä¸æ˜¯â€œ2025.12.17â€ï¼‰ï¼Œè¯†åˆ«ç‡æ›´é«˜ã€‚<br>
    </div>
    
    <div class="tip-box">
        1. <b>æœ¬åœ°ç¼“å­˜å·²å¼€å¯ï¼š</b> å­—ä½“å’Œæ¨¡æ¿ä¸‹è½½ä¸€æ¬¡åä¼šæ°¸ä¹…ä¿å­˜åœ¨æ‰‹æœº/ç”µè„‘ä¸­ï¼Œä¸‹æ¬¡æ‰“å¼€æ— éœ€æµé‡ï¼Œç§’å¼€ã€‚<br>
        2. å‚æ•°å’ŒåŠŸèƒ½ä¸åŸç‰ˆå®Œå…¨ä¸€è‡´ï¼Œæ”¯æŒå¾®è°ƒå’Œä¸Šä¼ ã€‚<br>
        3. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œ<b>è¯·ç­‰å¾…ä¸Šæ–¹èµ„æºåŠ è½½å®Œæ¯•</b>å†ç‚¹å‡»ç”Ÿæˆã€‚
    </div>
    
    <div class="mode-switch">
        <div class="mode-option active" onclick="switchMode('template')" id="btnTemplate">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</div>
        <div class="mode-option" onclick="switchMode('upload')" id="btnUpload">ä¸Šä¼ æ–°æ–‡ä»¶</div>
    </div>

    <div id="uploadContainer" class="upload-area">
        <label>ğŸ“‚ è¯·é€‰æ‹© PDF æ–‡ä»¶ï¼š</label>
        <input type="file" id="uploadPdf" accept="application/pdf" style="width:100%">
        <div style="font-size:12px; color:#666; margin-top:5px;">æ³¨æ„ï¼šå¦‚æœä¸Šä¼ çš„æ˜¯æ–°æ ¼å¼ï¼Œä¸‹æ–¹å‚æ•°å¯èƒ½éœ€è¦å¾®è°ƒã€‚</div>
    </div>

    <div class="debug-mode">
        <label style="cursor:pointer; display:flex; align-items:center; margin:0;">
            <input type="checkbox" id="debugMode"> 
            <span style="margin-left:8px; color:#856404; font-weight:bold;">å¼€å¯çº¢è‰²æ¡†è°ƒè¯•</span>
        </label>
    </div>

    <div id="fieldsContainer"></div>

    <button id="runBtn" onclick="startProcess()" disabled>æ­£åœ¨å‡†å¤‡èµ„æº...</button>
    <div id="statusBox" class="status">ç­‰å¾…å°±ç»ª...</div>
</div>

<script>
    const { PDFDocument, rgb } = PDFLib;
    let currentMode = 'template'; 
    
    // å…¨å±€èµ„æºå¯¹è±¡
    const CACHE = { font: null, templatePdf: null };

    // åˆå§‹åŒ–ç³»ç»Ÿï¼šæ£€æŸ¥ç¼“å­˜ï¼Œæ²¡æœ‰åˆ™ä¸‹è½½
    // åˆå§‹åŒ–ç³»ç»Ÿï¼šæ£€æŸ¥ç¼“å­˜ï¼Œæ²¡æœ‰åˆ™ä¸‹è½½
    async function initSystem() {
        const btn = document.getElementById('runBtn');
        const statusText = document.getElementById('resText');
        const pBar = document.getElementById('resProgress');
        const pFill = document.getElementById('pFill');

        try {
            // 1. æ£€æŸ¥å­—ä½“ (SimSun.ttf) - å­—ä½“é€šå¸¸ä¸å˜ï¼Œkeyå¯ä»¥ä¸æ”¹
            let fontBlob = await localforage.getItem('simsun_font');
            if (fontBlob) {
                statusText.innerText = "âœ… å­—ä½“å·²ä»æœ¬åœ°ç¼“å­˜åŠ è½½";
                CACHE.font = fontBlob;
            } else {
                statusText.innerText = "â³ æ­£åœ¨ä¸‹è½½å­—ä½“ (15MB)... è¯·å‹¿å…³é—­";
                pBar.style.display = 'block';
                CACHE.font = await downloadWithProgress('./simsun.ttf', pFill);
                await localforage.setItem('simsun_font', CACHE.font);
                statusText.innerText = "âœ… å­—ä½“ä¸‹è½½å®Œæˆå¹¶å·²ç¼“å­˜";
            }

            // ============ ä¿®æ”¹é‡ç‚¹å¼€å§‹ ============
            // 2. æ£€æŸ¥é»˜è®¤æ¨¡æ¿ (æ”¹ä¸º v2 ç‰ˆæœ¬ä»¥åŒºåˆ†æ—§ç‰ˆ)
            // ä¿®æ”¹ Key ä¸º 'template_pdf_v2'ï¼Œå¼ºåˆ¶æµè§ˆå™¨ä¸è¯»å–æ—§ç¼“å­˜
            let pdfBlob = await localforage.getItem('template_pdf_v2'); 
            
            if (pdfBlob) {
                statusText.innerText = "âœ… æ–°æ¨¡æ¿(V2)å·²ä»æœ¬åœ°ç¼“å­˜åŠ è½½"; // æç¤ºè¯­ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹
                CACHE.templatePdf = pdfBlob;
            } else {
                statusText.innerText = "â³ æ­£åœ¨ä¸‹è½½æ–°æ¨¡æ¿ (template2.pdf)...";
                // ä¿®æ”¹æ–‡ä»¶åä¸º template2.pdf
                CACHE.templatePdf = await fetch('./template2.pdf').then(res => res.arrayBuffer());
                // ä¿å­˜åˆ°æ–°çš„ Key ä¸­
                await localforage.setItem('template_pdf_v2', CACHE.templatePdf);
            }
            // ============ ä¿®æ”¹é‡ç‚¹ç»“æŸ ============

            // å…¨éƒ¨å°±ç»ª
            statusText.innerText = "âœ… æ‰€æœ‰èµ„æºå°±ç»ª (ç¦»çº¿å¯ç”¨)";
            statusText.style.color = "green";
            pBar.style.display = 'none';
            btn.disabled = false;
            btn.innerText = "ğŸš€ å¼€å§‹ç”Ÿæˆ";
            log("ç³»ç»Ÿå‡†å¤‡å°±ç»ªã€‚");

        } catch (e) {
            console.error(e);
            statusText.innerText = "âŒ èµ„æºåŠ è½½å¤±è´¥: " + e.message;
            statusText.style.color = "red";
        }
    }

    // ä¸‹è½½å¹¶æ˜¾ç¤ºè¿›åº¦
    async function downloadWithProgress(url, progressBarElem) {
        const response = await fetch(url);
        const reader = response.body.getReader();
        const contentLength = +response.headers.get('Content-Length');
        let receivedLength = 0;
        let chunks = [];

        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunks.push(value);
            receivedLength += value.length;
            if (contentLength && progressBarElem) {
                let percent = (receivedLength / contentLength) * 100;
                progressBarElem.style.width = percent + "%";
            }
        }
        let allChunks = new Uint8Array(receivedLength);
        let position = 0;
        for(let chunk of chunks) {
            allChunks.set(chunk, position);
            position += chunk.length;
        }
        return allChunks.buffer;
    }

    // é¡µé¢åŠ è½½åç«‹å³æ‰§è¡Œåˆå§‹åŒ–
    window.addEventListener('load', initSystem);

    function switchMode(mode) {
        currentMode = mode;
        const uploadDiv = document.getElementById('uploadContainer');
        const btnTemplate = document.getElementById('btnTemplate');
        const btnUpload = document.getElementById('btnUpload');

        if (mode === 'template') {
            uploadDiv.classList.remove('show');
            btnTemplate.classList.add('active');
            btnUpload.classList.remove('active');
        } else {
            uploadDiv.classList.add('show');
            btnTemplate.classList.remove('active');
            btnUpload.classList.add('active');
        }
    }

    const FIELDS = [
        { 
            id: 'product', label: 'äº§å“åç§°', 
            findText: 'CNG', newText: 'CNG', 
            offX: -3, offY: -6, boxH: 20, widthEx: 10 
        },
        { 
            id: 'loc', label: 'æè´§åœ°ç‚¹', 
            findText: 'å››å·çœè‡ªè´¡å¸‚216äº•', newText: 'å››å·çœè‡ªè´¡å¸‚219äº•', 
            offX: -3, offY: -6, boxH: 20, widthEx: 6 
        },
        { 
            id: 'date', label: 'æè´§æ—¶é—´', 
            findText: '2026.1.8', newText: '2025.12.17', 
            offX: -8, offY: -6, boxH: 20, widthEx: 30 
        },
        { 
            id: 'car', label: 'æ‰¿è¿è½¦è¾†', 
            findText: 'æ¸A5H315', newText: 'å·C52657â€”å·AEY29æŒ‚', 
            offX: -8, offY: -6, boxH: 20, widthEx: 20 
        },
        { 
            id: 'tel', label: 'è”ç³»ç”µè¯', 
            findText: '139', newText: '15328709269', 
            offX: -8, offY: -6, boxH: 20, widthEx: 35 
        }
    ];

    function initUI() {
        const container = document.getElementById('fieldsContainer');
        FIELDS.forEach(f => {
            container.innerHTML += `
                <div class="field-row">
                    <div class="main-inputs">
                        <div class="col" style="flex:0.7;">
                            <label>ğŸ” æŸ¥æ‰¾æ–‡å­—</label>
                            <input type="text" class="input-find" id="find_${f.id}" value="${f.findText}">
                        </div>
                        <div class="col">
                            <label>âœï¸ æ–°æ–‡å­—</label>
                            <input type="text" id="new_${f.id}" value="${f.newText}">
                        </div>
                    </div>
                    <div class="tweak-row"> 
                        <div class="tweak-item"><label>Xåç§»</label><input type="number" id="offX_${f.id}" value="${f.offX}"></div>
                        <div class="tweak-item"><label>Yåç§»</label><input type="number" id="offY_${f.id}" value="${f.offY}"></div>
                        <div class="tweak-item"><label>Hé«˜</label><input type="number" id="boxH_${f.id}" value="${f.boxH}"></div>
                        <div class="tweak-item"><label>W+å®½</label><input type="number" id="widthEx_${f.id}" value="${f.widthEx}"></div>
                    </div>
                </div>
            `;
        });
    }
    initUI();

    function log(msg) { document.getElementById('statusBox').innerText = msg; }

    async function scanCoordinates(pdfBuffer, targets) {
        // å¤åˆ¶ buffer é¿å… pdfjs æ¶ˆè€—æ‰åŸå§‹æ•°æ®
        const loadingTask = pdfjsLib.getDocument({ data: pdfBuffer.slice(0) });
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);
        const textContent = await page.getTextContent();
        let foundCoords = {};

        for (let item of textContent.items) {
            const str = item.str.trim();
            if(!str) continue;
            targets.forEach(target => {
                if (str.includes(target.text)) {
                    const x = item.transform[4];
                    const y = item.transform[5];
                    const w = item.width;
                    const h = item.height || 14; 
                    foundCoords[target.id] = { x, y, w, h };
                }
            });
        }
        return foundCoords;
    }

    async function startProcess() {
        const isDebug = document.getElementById('debugMode').checked;
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        let fileBytes = null;

        try {
            if (!CACHE.font) throw new Error("å­—ä½“å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™...");

            // 1. è·å– PDF æ•°æ®
            if (currentMode === 'template') {
                if (!CACHE.templatePdf) throw new Error("é»˜è®¤æ¨¡æ¿å°šæœªåŠ è½½å®Œæˆ...");
                log("â³ ä½¿ç”¨ç¼“å­˜çš„é»˜è®¤æ¨¡æ¿...");
                fileBytes = CACHE.templatePdf.slice(0); // å¤åˆ¶ä¸€ä»½ï¼Œé˜²æ­¢æ±¡æŸ“ç¼“å­˜
            } else {
                log("â³ è¯»å–ä¸Šä¼ æ–‡ä»¶...");
                const fileInput = document.getElementById('uploadPdf');
                if (!fileInput.files[0]) throw new Error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ª PDF æ–‡ä»¶ï¼");
                fileBytes = await fileInput.files[0].arrayBuffer();
            }

            log("â³ æ­£åœ¨æ‰«æå¹¶å¤„ç†...");
            const searchList = FIELDS.map(f => ({
                id: f.id,
                text: document.getElementById(`find_${f.id}`).value.trim()
            }));

            const coords = await scanCoordinates(fileBytes, searchList);
            const foundKeys = Object.keys(coords);
            
            if (foundKeys.length === 0) throw new Error("æ²¡æ‰¾åˆ°ä»»ä½•åŒ¹é…çš„æ—§æ–‡å­—ã€‚è¯·æ£€æŸ¥â€˜æŸ¥æ‰¾æ–‡å­—â€™æ˜¯å¦æ­£ç¡®ã€‚");

            // 2. åŠ è½½ PDF
            const pdfDoc = await PDFDocument.load(fileBytes);
            pdfDoc.registerFontkit(window.fontkit);
            
            // 3. ä½¿ç”¨ç¼“å­˜çš„å­—ä½“ (å…³é”®ä¿®æ”¹ç‚¹)
            // æ³¨æ„ï¼šfontkit éœ€è¦ ArrayBuffer çš„å‰¯æœ¬
            const customFont = await pdfDoc.embedFont(CACHE.font.slice(0));
            const page = pdfDoc.getPages()[0];

            FIELDS.forEach(f => {
                const found = coords[f.id];
                const newVal = document.getElementById(`new_${f.id}`).value;
                const offX = parseFloat(document.getElementById(`offX_${f.id}`).value); 
                const offY = parseFloat(document.getElementById(`offY_${f.id}`).value); 
                const boxH = parseFloat(document.getElementById(`boxH_${f.id}`).value); 
                const widthEx = parseFloat(document.getElementById(`widthEx_${f.id}`).value);

                if (found) {
                    const finalX = found.x + offX;
                    const finalY = found.y + offY;
                    const finalW = found.w + widthEx;
                    const finalH = boxH;

                    if (isDebug) {
                        page.drawRectangle({ x: finalX, y: finalY, width: finalW, height: finalH, borderColor: rgb(1, 0, 0), borderWidth: 1 });
                    } else {
                        page.drawRectangle({ x: finalX, y: finalY, width: finalW, height: finalH, color: rgb(1, 1, 1) });
                    }

                    const fontSize = 11;
                    const textYOffset = (finalH - fontSize) / 2 + 1.5;
                    page.drawText(newVal, { x: finalX + 4, y: finalY + textYOffset, size: fontSize, font: customFont, color: isDebug ? rgb(1, 0, 0) : rgb(0, 0, 0) });
                }
            });

            const pdfData = await pdfDoc.save();
            const blob = new Blob([pdfData], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = isDebug ? `çº¢æ¡†è°ƒè¯•_${Date.now()}.pdf` : `æè´§å•_${new Date().toLocaleDateString().replace(/\//g,'-')}.pdf`;
            link.click();
            log("âœ… æˆåŠŸï¼");

        } catch (err) {
            console.error(err);
            log("âŒ å‡ºé”™: " + err.message);
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>