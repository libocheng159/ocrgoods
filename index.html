<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æè´§å•ä¿®æ”¹ (æœ€ç»ˆå›ºåŒ–ç‰ˆ)</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: "Microsoft YaHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 850px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; display: inline-block; }
        
        .tip-box { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; margin-bottom: 20px; color: #2e7d32; font-size: 13px; }
        
        .field-row { background: #fafafa; border: 1px solid #eee; padding: 10px; margin-bottom: 12px; border-radius: 6px; }
        .main-inputs { display: flex; gap: 10px; margin-bottom: 8px; }
        .col { flex: 1; }
        
        .tweak-row { display: flex; gap: 8px; align-items: center; border-top: 1px dashed #ddd; padding-top: 8px; }
        .tweak-item { display: flex; align-items: center; font-size: 12px; color: #666; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd;}
        .tweak-item label { margin-right: 4px; font-weight: normal; margin-bottom: 0; }
        .tweak-item input { width: 40px; padding: 2px; text-align: center; border: none; border-bottom: 1px solid #ccc; font-weight: bold; color: #333;}
        
        label { display: block; font-weight: bold; font-size: 13px; color: #333; margin-bottom: 4px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        input:focus { border-color: #007bff; outline: none; }
        
        .input-find { background-color: #fffde7; border-color: #fbc02d; }
        
        button { width: 100%; padding: 14px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        button:hover { background: #0056b3; }
        
        .debug-mode { background: #fff3cd; padding: 10px; border: 1px solid #ffeeba; border-radius: 4px; margin-bottom: 15px; font-size: 14px; display: flex; align-items: center; }
        .status { margin-top: 15px; padding: 10px; border-radius: 6px; font-size: 13px; min-height: 20px; font-family: monospace; white-space: pre-wrap; background: #eee; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸš€ æ™ºèƒ½æè´§å•ä¿®æ”¹ (å‚æ•°å›ºåŒ–ç‰ˆ)</h2>
    
    <div class="tip-box">
        <b>å·²åŠ è½½æœ€ç»ˆå‚æ•°ï¼š</b> ç³»ç»Ÿå·²è‡ªåŠ¨åº”ç”¨æ‚¨è°ƒè¯•å¥½çš„â€œé»„é‡‘å‚æ•°â€ã€‚<br>
        æ—§æ–‡å­—å…³é”®è¯å·²ç²¾ç®€ï¼ˆå¦‚åªæœâ€œå››å·çœâ€ï¼‰ï¼Œä»¥æé«˜è¯†åˆ«ç‡ã€‚
    </div>

    <div style="margin-bottom: 15px;">
        <label>1. ä¸Šä¼  PDF æ–‡ä»¶</label>
        <input type="file" id="uploadPdf" accept="application/pdf" style="width:100%">
    </div>

    <div class="debug-mode">
        <label style="cursor:pointer; display:flex; align-items:center; margin:0;">
            <input type="checkbox" id="debugMode"> 
            <span style="margin-left:8px; color:#856404; font-weight:bold;">å¼€å¯çº¢è‰²æ¡†è°ƒè¯•</span>
        </label>
        <span style="margin-left:15px; font-size:12px; color:#666;">å¦‚æœå‘ç°ä½ç½®åç§»ï¼Œè¯·å‹¾é€‰æ­¤é¡¹æ£€æŸ¥ã€‚</span>
    </div>

    <div id="fieldsContainer"></div>

    <button id="runBtn" onclick="startProcess()">ğŸš€ å¼€å§‹è¯†åˆ«å¹¶ç”Ÿæˆ</button>
    <div id="statusBox" class="status">å‡†å¤‡å°±ç»ªã€‚</div>
</div>

<script>
    const { PDFDocument, rgb } = PDFLib;

    // === ğŸ† æœ€ç»ˆå›ºåŒ–å‚æ•° (æºè‡ªæ‚¨çš„æˆªå›¾) ===
    // 1. findText: æ”¹æˆäº†æ›´çŸ­çš„å…³é”®è¯ï¼Œè¯†åˆ«æ›´å‡†
    // 2. offX/offY: å†™å…¥äº†æ‚¨è°ƒè¯•å¥½çš„ -3/-6/-8 ç­‰æ•°å€¼
    // 3. widthEx: å†™å…¥äº†æ‚¨è°ƒæ•´å¥½çš„å®½åº¦
    const FIELDS = [
        { 
            id: 'loc', label: 'æè´§åœ°ç‚¹', 
            findText: 'å››å·çœ',  // ç®€çŸ­å…³é”®è¯
            newText: 'å››å·çœè‡ªè´¡å¸‚219äº•', 
            offX: -3, offY: -6, boxH: 20, widthEx: 6 
        },
        { 
            id: 'date', label: 'æè´§æ—¶é—´', 
            findText: '2025',   // ç®€çŸ­å…³é”®è¯
            newText: '2025.12.18', 
            offX: -8, offY: -6, boxH: 20, widthEx: 30 
        },
        { 
            id: 'car', label: 'æ‰¿è¿è½¦è¾†', 
            findText: 'å·C52657', // ç®€çŸ­å…³é”®è¯
            newText: 'å·C52657â€”å·AEY29æŒ‚', 
            offX: -8, offY: -6, boxH: 20, widthEx: 20 
        },
        { 
            id: 'tel', label: 'è”ç³»ç”µè¯', 
            findText: '153',    // ç®€çŸ­å…³é”®è¯
            newText: '15328709269', 
            offX: -8, offY: -6, boxH: 20, widthEx: 35 
        }
    ];

    function initUI() {
        const container = document.getElementById('fieldsContainer');
        FIELDS.forEach(f => {
            container.innerHTML += `
                <div class="field-row">
                    <div class="main-inputs">
                        <div class="col" style="flex:0.7;">
                            <label>ğŸ” æ—§æ–‡å­— (å®šä½)</label>
                            <input type="text" class="input-find" id="find_${f.id}" value="${f.findText}">
                        </div>
                        <div class="col">
                            <label>âœï¸ æ–°æ–‡å­—</label>
                            <input type="text" id="new_${f.id}" value="${f.newText}">
                        </div>
                    </div>
                    <div class="tweak-row">
                        <span style="font-size:12px; font-weight:bold; color:#007bff; margin-right:5px;">å‚æ•°ä¿®æ­£:</span>
                        <div class="tweak-item"><label>Xåç§»</label><input type="number" id="offX_${f.id}" value="${f.offX}"></div>
                        <div class="tweak-item"><label>Yåç§»</label><input type="number" id="offY_${f.id}" value="${f.offY}"></div>
                        <div class="tweak-item"><label>æ¡†é«˜åº¦</label><input type="number" id="boxH_${f.id}" value="${f.boxH}"></div>
                        <div class="tweak-item"><label>å¢å®½</label><input type="number" id="widthEx_${f.id}" value="${f.widthEx}"></div>
                    </div>
                </div>
            `;
        });
    }
    initUI();

    function log(msg) { document.getElementById('statusBox').innerText = msg; }

    async function scanCoordinates(pdfBuffer, targets) {
        const loadingTask = pdfjsLib.getDocument({ data: pdfBuffer });
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);
        const textContent = await page.getTextContent();
        
        let foundCoords = {};
        console.log("æ‰«æä¸­...");

        for (let item of textContent.items) {
            const str = item.str.trim();
            if(!str) continue;

            targets.forEach(target => {
                // åªè¦åŒ…å«å…³é”®è¯å°±åŒ¹é… (ä¾‹å¦‚åŒ…å«"å››å·çœ"å³å¯)
                if (str.includes(target.text)) {
                    const x = item.transform[4];
                    const y = item.transform[5];
                    const w = item.width;
                    const h = item.height || 14; 
                    foundCoords[target.id] = { x, y, w, h };
                }
            });
        }
        return foundCoords;
    }

    async function startProcess() {
        const fileInput = document.getElementById('uploadPdf');
        const isDebug = document.getElementById('debugMode').checked;
        const btn = document.getElementById('runBtn');
        
        if (!fileInput.files[0]) { alert("è¯·å…ˆä¸Šä¼ PDFï¼"); return; }
        
        btn.disabled = true;
        log("â³ æ­£åœ¨å¤„ç†...");

        try {
            const fileBytes = await fileInput.files[0].arrayBuffer();

            // 1. è·å–ç•Œé¢ä¸Šçš„æ—§æ–‡å­—å…³é”®è¯
            const searchList = FIELDS.map(f => ({
                id: f.id,
                text: document.getElementById(`find_${f.id}`).value.trim()
            }));

            // 2. æ‰«æåæ ‡
            const coords = await scanCoordinates(fileBytes, searchList);
            const foundKeys = Object.keys(coords);
            if (foundKeys.length === 0) {
                alert("âš ï¸ æœªæ‰¾åˆ°ä»»ä½•åŒ¹é…æ–‡å­—ï¼è¯·æ£€æŸ¥PDFæ˜¯å¦ä¸ºçº¯å›¾ç‰‡ï¼Œæˆ–å°è¯•ç²¾ç®€å·¦ä¾§æœç´¢å…³é”®è¯ã€‚");
            }

            // 3. å‡†å¤‡ PDF ä¿®æ”¹
            const pdfDoc = await PDFDocument.load(fileBytes);
            pdfDoc.registerFontkit(window.fontkit);
            
            const fontUrl = 'https://cdn.jsdelivr.net/npm/@fontsource/noto-sans-sc@5.0.0/files/noto-sans-sc-chinese-simplified-400-normal.woff';
            const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
            const customFont = await pdfDoc.embedFont(fontBytes);
            const page = pdfDoc.getPages()[0];

            // 4. æ‰§è¡Œç»˜åˆ¶
            FIELDS.forEach(f => {
                const found = coords[f.id];
                const newVal = document.getElementById(`new_${f.id}`).value;
                
                const offX = parseFloat(document.getElementById(`offX_${f.id}`).value); 
                const offY = parseFloat(document.getElementById(`offY_${f.id}`).value); 
                const boxH = parseFloat(document.getElementById(`boxH_${f.id}`).value); 
                const widthEx = parseFloat(document.getElementById(`widthEx_${f.id}`).value);

                if (found) {
                    const finalX = found.x + offX;
                    const finalY = found.y + offY;
                    const finalW = found.w + widthEx;
                    const finalH = boxH;

                    // ç”»æ¡†
                    if (isDebug) {
                        page.drawRectangle({
                            x: finalX, y: finalY, width: finalW, height: finalH,
                            borderColor: rgb(1, 0, 0), borderWidth: 1,
                        });
                    } else {
                        page.drawRectangle({
                            x: finalX, y: finalY, width: finalW, height: finalH,
                            color: rgb(1, 1, 1),
                        });
                    }

                    // å†™å­— (å‚ç›´å±…ä¸­)
                    const fontSize = 11;
                    const textYOffset = (finalH - fontSize) / 2 + 1.5;

                    page.drawText(newVal, {
                        x: finalX + 4, 
                        y: finalY + textYOffset,
                        size: fontSize,
                        font: customFont,
                        color: isDebug ? rgb(1, 0, 0) : rgb(0, 0, 0),
                    });
                }
            });

            const pdfData = await pdfDoc.save();
            const blob = new Blob([pdfData], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = isDebug ? `çº¢æ¡†è°ƒè¯•_${Date.now()}.pdf` : `æè´§å•_ä¿®æ”¹å®Œæˆ.pdf`;
            link.click();
            log("âœ… æˆåŠŸï¼æ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½ã€‚");

        } catch (err) {
            console.error(err);
            log("âŒ å‡ºé”™: " + err.message);
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>